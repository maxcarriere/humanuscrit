{% comment %}
  Arborescence du dossier courant ou indiqué : sous-dossiers et fichiers.
  Utilisation : {% include arborescence_dossier.html %}
  Ou : {% include arborescence_dossier.html dossier="textes/prescriptum" %}
  Dynamique : nouveau fichier ou sous-dossier = apparition automatique.
{% endcomment %}
{% if include.dossier %}
  {% assign dossier = include.dossier %}
{% elsif page.name == "index.md" %}
  {% assign path_parts = page.path | split: "/" %}
  {% assign n = path_parts | size | minus: 2 %}
  {% assign dossier = path_parts[0] %}
  {% for i in (1..n) %}
    {% assign dossier = dossier | append: "/" | append: path_parts[i] %}
  {% endfor %}
{% endif %}
{% if dossier %}
{% assign prefix = dossier | append: "/" %}
{% assign dossier_norm = dossier | replace: "\\", "/" %}
<ul class="arborescence-textes">
  {% comment %} Section Réflexions : ordre fixe Préambule, Chapitre 0, Chapitre 1 {% endcomment %}
  {% if dossier_norm == "textes/reflexions" %}
    {% comment %} Ordre fixe : on cherche chaque page par son chemin complet (robuste Windows/Linux) {% endcomment %}
    {% assign ref_files = "préambule.md|0_existence.md|1_systemes_vision_descriptive.md|annexe_prerequis_mathematiques.md" | split: "|" %}
    {% for ref_file in ref_files %}
      {% assign p = "" %}
      {% assign expected_path = dossier_norm | append: "/" | append: ref_file %}
      {% for candidat in site.pages %}
        {% assign path_norm = candidat.path | replace: "\\", "/" %}
        {% if path_norm == expected_path %}
          {% assign p = candidat %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if p %}
        {% assign affichage_titre = p.short_title | default: p.title %}
        <li><a href="{{ p.url | relative_url }}">{% include lib_display_name.html name=p.name title=affichage_titre %}</a></li>
      {% endif %}
    {% endfor %}
  {% else %}
  {% assign all_pages = site.pages | where_exp: "p", "p.path contains prefix" | sort: "order" %}
  {% for p in all_pages %}
    {% assign path_str = p.path | replace: "\\", "/" %}
    {% assign prefix_norm = prefix | replace: "\\", "/" %}
    {% unless path_str contains prefix_norm %}
      {% continue %}
    {% endunless %}
    {% assign dossier_norm = dossier | replace: "\\", "/" %}
    {% if path_str == dossier_norm %}
      {% continue %}
    {% endif %}
    {% assign full_idx = dossier_norm | append: "/index.md" %}
    {% assign full_readme = dossier | append: "/README.md" %}
    {% if path_str == full_idx or path_str == full_readme %}
      {% continue %}
    {% endif %}
    {% assign rel_path = path_str | remove_first: prefix_norm %}
    {% assign rel_parts = rel_path | split: "/" %}
    {% assign depth = rel_parts | size %}
    {% if depth == 1 %}
      {% assign affichage_titre = p.short_title | default: p.title %}
      {% if p.name == "index.md" %}
        {% assign item_name = rel_parts[0] %}
        <li>
          <a href="{{ p.url | relative_url }}">{% include lib_display_name.html name=item_name title=affichage_titre %}</a>
        </li>
      {% elsif p.name != "README.md" %}
        <li>
          <a href="{{ p.url | relative_url }}">
            {% include lib_display_name.html name=p.name title=affichage_titre %}
          </a>
        </li>
      {% endif %}
    {% elsif depth == 2 and p.name == "index.md" %}
      {% assign affichage_titre = p.short_title | default: p.title %}
      {% assign item_name = rel_parts[0] %}
      <li>
        <a href="{{ p.url | relative_url }}">{% include lib_display_name.html name=item_name title=affichage_titre %}</a>
      </li>
    {% elsif depth == 2 and p.name != "README.md" %}
      {% assign affichage_titre = p.short_title | default: p.title %}
      <li>
        <a href="{{ p.url | relative_url }}">
          {% include lib_display_name.html name=p.name title=affichage_titre %}
        </a>
      </li>
    {% endif %}
  {% endfor %}
  {% endif %}
</ul>
{% endif %}
